### Авторизация на SSH сервере по ключу

```
sudo apt-get install openssh-server
```
Для начала, произведем начальную настройку ssh сервера для авторизации по ключу. Откроем на редактирование файл /etc/ssh/sshd_config
```
sudo nano /etc/ssh/sshd_config
```
Тут нас интересуют следующие строки, их всего три (Должны быть раскомментированы, и иметь указанные мной значения):
```
...........
RSAAuthentication yes
PubkeyAuthentication yes
...........
AuthorizedKeysFile     %h/.ssh/authorized_keys
```
Перезапустим сервер ssh:
```
sudo restart ssh
```
Итак, привели строки файла конфигурации ssh к требуемому виду.
Далее необходимо будет сгенерировать ключи для авторизации. Дальнейшие действия производятся на самом ssh сервере (Не на компьютере на котором вы будете работать при помощи ssh клиента, а именно там где установили open-ssh):
Вводим следующую команду:
```
ssh-keygen -t rsa
```
Вы можете вместо RSA использовать DSA. В отличии от RSA, DSA используется только для цифровой подписи, и не используется для шифрования.
Далее в ответ мы получим следующие строки:
Введите название ключа, в принципе это не важно, но желательно что бы в дальнейшем не запутаться, если будет несколько ключей.
```
Generating public/private rsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_rsa):
```
Тут и далее, будем считать что в данном примере я ввел melfis.ru-rsa
Теперь система попросит ввести пароль для сертификата, я ввожу пароль.
```
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
```
Сертификаты сгенерированы:
```
Your identification has been saved in melfis.ru-rsa.
Your public key has been saved in user.ru-rsa.pub.
The key fingerprint is:
23:3f:f4:5c:c4:48:6b:37:4c:ca:f5:24:29:63:e7:ae user@NAT-SERVER
The key's randomart image is:
+--[ RSA 2048]----+
|          . -..  |
|         o+jo+   |
|         .^=_ .  |
|   ..-  . k...   |
|      . D  ..    |
|       + + ..    |
|        O o.     |
|      o_O E      |
|                 |
+-----------------+
```
Теперь в папке в которой вы находились, имеются два ключа:
```
user.ru-rsa
user.ru-rsa.pub
```
Один из них приватный: user.ru-rsa, другой публичный: user.ru-rsa.pub.
Теперь Вам необходимо установить на Ваш сервер сгенерированный ключ. (Да, мы находимся все еще на сервере где установлен Spen-SSH). По мимо установки ключа, мы сразу выставим права на хранилище ключей.
Выполним следующие команды:
```
at user.ru-rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```
Теперь перейдем на компьютер, который должен быть авторизирован на ssh сервере по ключу. (Теперь мы работаем на Вашем локальном компьютере.)
Заберем ключ к себе на компьютер следующей командой (Я предопологаю, что Вы выполняли предыдущие пункты в домашнем каталоге пользователя на сервере):
```
scp ИМЯ_ПОЛЬЗОВАТЕЛЯ@АДРЕС_СЕРВЕРА:~/user-rsa ~/.ssh/user-key
```
После того как ключ получен, загрузим его в наше локальное хранилище:
```
ssh-add ~/.ssh/user-key
```
Введите пароль который Вы установили для этого ключа. После того как ключ успешно загружен, пробуем подключится к серверу:
```
ssh ИМЯ_ПОЛЬЗОВАТЕЛЯ@АДРЕС_СЕРВЕРА
```
В результате чего, пароль запрашиваться не будет. Если Вам удалось подключится к серверу SSH посредством ключа, то наверное не плохим решением будет полное отключение авторизации по паролю. Для этого на сервере необходимо открыть файл /etc/ssh/sshd_config и изменить следующую строку:
```
PasswordAuthentication yes
```
на вот такую:
```
PasswordAuthentication no
```
И не забудьте перезапустить сервер Open-SSH
На этом все. Можете «слить» созданные вами ключи на флешку и использовать их для авторизации по ssh без ввода пароля.

### Авторизация по SSH с использованием ключей в условиях шифрования домашней директории

Хрестоматийный вариант настройки авторизации по SSH с использованием ключей знают все: открытый ключ записывается в ~/.ssh/authorized_keys. В случае, если применяется шифрование домашней папки, то система не сможет прочесть данный файл. Следовательно, необходимо разместить эти данные за пределами зашифрованной домашней папки.

Предлагаю размещать файл authorized_keys в каталоге /etc/{username}/.ssh. В таком случае в /etc/ssh/sshd_config следует добавить соответствующую строку:
```
AuthorizedKeysFile /etc/%u/.ssh/authorized_keys
```
Или:
```
AuthorizedKeysFile /etc/ssh/authorized_keys/%u
```
ИМХО так удобнее.

Не будет лишним также расставить параноидальные права:
```
chown -R {username}:{username} /etc/{username}
chmod 1700 /etc/{username}
chmod 0100 /etc/{username}/.ssh
chmod 0600 /etc/{username}/.ssh/authorized_keys
```
Последняя же рекомендация варьируется в зависимости от принятых методик управления системами.

Взято с Хабра: http://habrahabr.ru/post/103668/
